name: Auto Token Extractor

on:
  schedule:
    - cron: "*/30 * * * *"  # Har 30 min trigger
  workflow_dispatch:

jobs:
  run-extractor:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # for pushing to gh-pages

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run token extractor
        id: extract
        run: |
          echo "ðŸš€ Starting job..."

          # Step 1: Trigger Mango API job
          response=$(curl -s "https://mango.sievedata.com/v2/push" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4" \
            -d '{
              "function": "ah-aroojharis-gmail-com/google-labs-token-extractor",
              "inputs": {
                "github_cookies_url": "https://raw.githubusercontent.com/hackerhtml02/cookie-update/main/google_labs_cookies.json",
                "github_repo": "hackerhtml02/cookie-update",
                "github_file_path": "google_labs_cookies.json",
                "prompt_text": "cute cat"
              }
            }')

          job_id=$(echo "$response" | jq -r '.id')
          echo "ðŸ†” Job ID: $job_id"

          # Step 2: Wait for job to complete
          for i in {1..60}; do
            job_json=$(curl -s "https://mango.sievedata.com/v2/jobs/$job_id" \
              -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4")
            status=$(echo "$job_json" | jq -r '.status')
            echo "Status: $status"
            if [ "$status" == "completed" ] || [ "$status" == "finished" ]; then
              echo "âœ… Job finished successfully!"
              break
            fi
            echo "â³ Waiting 10s..."
            sleep 10
          done

          # Step 3: Verify completion
          if [ "$status" != "completed" ] && [ "$status" != "finished" ]; then
            echo "âŒ Job did not finish in time"
            exit 1
          fi

          # Step 4: Extract the output URL (handles nested arrays)
          output_url=$(echo "$job_json" | jq -r '.. | objects | .url? // empty' | head -n 1)

          if [ -z "$output_url" ]; then
            echo "âŒ Could not extract output URL"
            echo "$job_json" | jq .
            exit 1
          fi

          echo "ðŸ”— Output URL: $output_url"

          # Step 5: Fetch token text
          token_text=$(curl -s "$output_url")
          echo "ðŸª™ Full Token (hidden for security):"
          echo "${token_text:0:8}...[${#token_text}] chars total..."

          # Step 6: Mask token for public display (avoid GitHub secret block)
          masked_token="${token_text:0:10}...[hidden]...${token_text: -6}"

          # Step 7: Save masked token to files
          echo "$masked_token" > token_output.txt

          # Step 8: Generate index.html for GitHub Pages
          cat <<EOF > index.html
          <html>
          <head>
            <meta http-equiv="refresh" content="30">
            <title>Auto Token Update</title>
            <style>
              body { font-family: monospace; padding: 20px; background: #0d1117; color: #c9d1d9; }
              pre { background: #161b22; padding: 10px; border-radius: 8px; white-space: pre-wrap; }
              .footer { color: #8b949e; font-size: 12px; margin-top: 10px; }
            </style>
          </head>
          <body>
            <h2>ðŸ”‘ Latest Token (Masked for Security)</h2>
            <pre>$masked_token</pre>
            <div class="footer">Last updated: $(date)</div>
          </body>
          </html>
          EOF

      - name: Push to gh-pages branch (GitHub Pages)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B gh-pages
          git add index.html token_output.txt
          git commit -m "Updated token $(date)" || echo "No new changes"
          git push -f origin gh-pages

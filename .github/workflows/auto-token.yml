name: Auto Token Extractor

on:
  schedule:
    - cron: "*/30 * * * *"  # har 30 minute
  workflow_dispatch:

jobs:
  run-extractor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run token extractor
        id: extract
        run: |
          echo "Starting job..."
          response=$(curl -s "https://mango.sievedata.com/v2/push" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4" \
            -d '{
              "function": "ah-aroojharis-gmail-com/google-labs-token-extractor",
              "inputs": {
                "github_cookies_url": "https://raw.githubusercontent.com/hackerhtml02/cookie-update/main/google_labs_cookies.json",
                "github_repo": "hackerhtml02/cookie-update",
                "github_file_path": "google_labs_cookies.json",
                "prompt_text": "cute cat"
              }
            }')

          job_id=$(echo "$response" | jq -r '.id')
          echo "Job ID: $job_id"

          # Wait for job to complete or finish
          for i in {1..60}; do
            status=$(curl -s "https://mango.sievedata.com/v2/jobs/$job_id" \
              -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4" | jq -r '.status')

            echo "Status: $status"
            if [ "$status" == "completed" ] || [ "$status" == "finished" ]; then
              echo "✅ Job finished successfully!"
              break
            fi
            echo "Waiting 10s..."
            sleep 10
          done

          # Confirm status before proceeding
          if [ "$status" != "completed" ] && [ "$status" != "finished" ]; then
            echo "❌ Job did not complete successfully."
            exit 1
          fi

          # Get output URL
          output_url=$(curl -s "https://mango.sievedata.com/v2/jobs/$job_id" \
            -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4" | jq -r '.outputs.token_url')

          echo "Output URL: $output_url"

          # Fetch token text
          token_text=$(curl -s "$output_url")
          echo "Token received: ${#token_text} chars"

          # Save token to file
          echo "$token_text" > token_output.txt

      - name: Commit and push updated token
        if: success()  # only runs if previous step succeeded
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add token_output.txt
          git commit -m "Updated token $(date)"
          git push

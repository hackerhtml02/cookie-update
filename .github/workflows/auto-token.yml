name: Auto Token Extractor

on:
  schedule:
    - cron: "*/30 * * * *"  # Har 30 min
  workflow_dispatch:

jobs:
  run-extractor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run token extractor
        id: extract
        run: |
          echo "ðŸš€ Starting job..."
          response=$(curl -s "https://mango.sievedata.com/v2/push" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4" \
            -d '{
              "function": "ah-aroojharis-gmail-com/google-labs-token-extractor",
              "inputs": {
                "github_cookies_url": "https://raw.githubusercontent.com/hackerhtml02/cookie-update/main/google_labs_cookies.json",
                "github_repo": "hackerhtml02/cookie-update",
                "github_file_path": "google_labs_cookies.json",
                "prompt_text": "cute cat"
              }
            }')

          job_id=$(echo "$response" | jq -r '.id')
          echo "ðŸ†” Job ID: $job_id"

          # Wait for job to finish
          for i in {1..60}; do
            job_json=$(curl -s "https://mango.sievedata.com/v2/jobs/$job_id" \
              -H "X-API-Key: FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4")
            status=$(echo "$job_json" | jq -r '.status')
            echo "Status: $status"
            if [ "$status" == "completed" ] || [ "$status" == "finished" ]; then
              echo "âœ… Job finished successfully!"
              break
            fi
            echo "â³ Waiting 10s..."
            sleep 10
          done

          # Verify job completion
          if [ "$status" != "completed" ] && [ "$status" != "finished" ]; then
            echo "âŒ Job did not finish in time"
            exit 1
          fi

          # Extract the URL from outputs
          output_url=$(echo "$job_json" | jq -r '.outputs[0].url // .outputs.url')
          echo "ðŸ”— Output URL: $output_url"

          # Fetch the text content from that URL
          token_text=$(curl -s "$output_url")
          echo "ðŸª™ Token received: ${#token_text} characters"

          # Save to file for Pages
          echo "$token_text" > token_output.txt

          # Generate index.html for GitHub Pages
          cat <<EOF > index.html
          <html>
          <head>
            <meta http-equiv="refresh" content="30">
            <title>Auto Token Update</title>
            <style>
              body { font-family: monospace; padding: 20px; background: #0d1117; color: #c9d1d9; }
              pre { background: #161b22; padding: 10px; border-radius: 8px; white-space: pre-wrap; }
              .footer { color: #8b949e; font-size: 12px; margin-top: 10px; }
            </style>
          </head>
          <body>
            <h2>ðŸ”‘ Latest Token (Auto Updated)</h2>
            <pre>$token_text</pre>
            <div class="footer">Last updated: $(date)</div>
          </body>
          </html>
          EOF

      - name: Push to gh-pages branch (GitHub Pages)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B gh-pages
          git add index.html token_output.txt
          git commit -m "Updated token $(date)" || echo "No new changes"
          git push -f origin gh-pages

name: Save Google Labs Session & Auto Token Extractor

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  actions: write

jobs:
  main-job:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Python + Playwright
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Playwright
        run: |
          python -m pip install --upgrade pip
          pip install playwright==1.41.0
          playwright install chromium

      # 3Ô∏è‚É£ Run login.py
      - name: Run login script (save state)
        env:
          GOOGLE_EMAIL: ${{ secrets.GOOGLE_EMAIL }}
          GOOGLE_PASSWORD: ${{ secrets.GOOGLE_PASSWORD }}
        run: python login.py

      # 4Ô∏è‚É£ Check google_state.json
      - name: Verify saved state file
        run: |
          if [ -f google_state.json ]; then
            echo "‚úÖ google_state.json found:"
            ls -lh google_state.json
          else
            echo "‚ùå google_state.json missing!"
            exit 1
          fi

      # 5Ô∏è‚É£ Commit & Push
      - name: Commit and push google_state.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add google_state.json || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: update google_state.json (auto)"
            git push origin HEAD
          else
            echo "No changes to commit"
          fi

      # 6Ô∏è‚É£ TOKEN EXTRACTOR with Auto-Retry (3 Attempts)
      - name: Run Token Extractor (with retry)
        id: extract
        run: |
          API_KEY="FuPVQWihujpMNw86fq8wswm-asNoq2BbgN_C4VhjOE4"

          attempt=1
          max_attempts=3
          success=0

          while [ $attempt -le $max_attempts ]
          do
            echo "üîÑ Attempt $attempt of $max_attempts"

            response=$(curl -s "https://mango.sievedata.com/v2/push" \
              -X POST \
              -H "Content-Type: application/json" \
              -H "X-API-Key: $API_KEY" \
              -d '{
                "function": "ah-aroojharis-gmail-com/google-labs-token-extractor",
                "inputs": {
                  "github_cookies_url": "https://raw.githubusercontent.com/hackerhtml02/cookie-update/main/google_state.json",
                  "github_repo": "hackerhtml02/cookie-update",
                  "github_file_path": "google_state.json",
                  "prompt_text": "cute cat"
                }
              }')

            job_id=$(echo "$response" | jq -r '.id')
            echo "üÜî Job ID: $job_id"

            # Poll job status
            for i in {1..60}; do
              job_json=$(curl -s "https://mango.sievedata.com/v2/jobs/$job_id" \
                -H "X-API-Key: $API_KEY")
              status=$(echo "$job_json" | jq -r '.status')
              echo "‚è≥ Status: $status"

              if [ "$status" == "completed" ] || [ "$status" == "finished" ]; then
                echo "‚úÖ Job completed!"
                success=1
                break
              elif [ "$status" == "error" ]; then
                echo "‚ùå Error detected, breaking early..."
                break
              fi

              sleep 10
            done

            # If success break loop
            if [ $success -eq 1 ]; then
              echo "üéâ Extractor finished successfully!"
              break
            else
              echo "‚ö†Ô∏è Attempt $attempt FAILED ‚Äî retrying..."
              attempt=$((attempt + 1))
              sleep 5
            fi
          done

          if [ $success -ne 1 ]; then
            echo "‚ùå All attempts failed!"
            exit 1
          fi

          # Extract token
          output_url=$(echo "$job_json" | jq -r '.. | objects | .url? // empty' | head -n 1)

          token_text=$(curl -s "$output_url")
          echo "$token_text" | base64 | tr -d '\n' > token.txt
          echo "üîê Token saved!"

      # 7Ô∏è‚É£ Save token.txt
      - name: Commit and push token.txt
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin main
          git checkout main
          git pull --rebase origin main || true
          git add token.txt
          git commit -m "Updated token $(date)" || echo "No new changes"
          git push origin main --force

      # 8Ô∏è‚É£ Auto restart
      - name: Auto restart after 1 hour
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚è≥ Waiting 1 hour..."
          sleep 3600
          echo "üîÑ Restarting workflow..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/save-google-labs-session.yml/dispatches \
            -d '{"ref":"main"}'
